# Node.js with React
# Build a Node.js project that uses React.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

trigger:
    - '*'

stages:
    - stage: 'Build'
      displayName: 'Build the front end react web application'
      jobs:
          - job: 'Build'
            displayName: 'Build job'
            pool:
                vmImage: 'ubuntu-latest'

            steps:
                - task: NodeTool@0
                  inputs:
                      versionSpec: '14.15.4'
                  displayName: 'Install Node.js'

                - script: 'npm install --global yarn'
                  displayName: 'Install Yarn'

                - script: |
                      yarn install
                      yarn build
                  displayName: 'yarn install and build'

                - task: CopyFiles@2
                  inputs:
                      sourceFolder: 'build'
                      contents: '**/*'
                      targetFolder: '$(Build.ArtifactStagingDirectory)'
                      cleanTargetFolder: true

                - task: ArchiveFiles@2
                  inputs:
                      rootFolderOrFile: '$(Build.ArtifactStagingDirectory)'
                      archiveType: 'zip'
                      archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'
                      includeRootFolder: false
                      replaceExistingArchive: true

                - task: PublishBuildArtifacts@1
                  displayName: 'Publish Artifact: drop'
                  inputs:
                      pathtoPublish: '$(Build.ArtifactStagingDirectory)/$(Build.BuildId).zip'

                - task: PublishBuildArtifacts@1
                  displayName: 'Publish Artifact: drop'
                  inputs:
                      pathtoPublish: 'infrastructure'

    - stage: 'Deploy'
      displayName: 'Deploy the react front end web application'
      dependsOn: Build
      jobs:
          - deployment: Deploy
            pool: 'MyAgentPool'
            environment: Development
            strategy:
                runOnce:
                    deploy:
                        steps:
                            - download: current
                              artifact: drop

                            - task: AzurePowerShell@5
                              inputs:
                                  azureSubscription: 'uami-devops'
                                  ScriptType: 'FilePath'
                                  ScriptPath: '$(Pipeline.Workspace)/drop/Deploy-AzTemplate.ps1'
                                  ScriptArguments: -Location 'australiaeast' -ResourceGroupName 'micolk-dev-template-rg' -ArtifactStagingDirectory '$(Pipeline.Workspace)/drop'
                                  azurePowerShellVersion: 'LatestVersion'

                            - task: AzureWebApp@1
                              displayName: 'Azure App Service Deploy: react website'
                              inputs:
                                  azureSubscription: 'uami-devops'
                                  appName: 'micolk-frontend-react-dev'
                                  appType: 'webApp'
                                  package: '$(Pipeline.Workspace)/drop/$(Build.BuildId).zip'
